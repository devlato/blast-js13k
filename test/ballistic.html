<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>blastoff [[test]]</title>
        <link rel="stylesheet" href="../pub/game.css">
    </head>
    <body>
        <div id="container">
            <canvas id="L1" width="900" height="600"></canvas>
            <canvas id="L2" width="900" height="600"></canvas>
        </div>
        <script src="../scripts/util.js"></script>
        <script src="../scripts/rocket.js"></script>
        <script>
            function intersections(x, y, r) {
                var r0 = 64
                var dist = Math.sqrt(x * x + y * y)
                if (dist > r0 + r || dist < Math.abs(r0 - r))
                    return false

                var a = (r0 * r0 - r * r + dist * dist) / (2 * dist)
                var x2 = x * a / dist
                var y2 = y * a / dist
                var b = Math.sqrt(r0 * r0 - a * a)
                var rx = -y * b / dist
                var ry = x * b / dist

                return [
                    x2 + rx, y2 + ry,
                    x2 - rx, y2 - ry
                ]
            }

            function ballistic() {
                var dist, a
                dist = Math.sqrt(this.x * this.x + this.y * this.y)
                this.r = 0.75 * dist
                a = Math.atan(-this.x / this.y) + Math.asin(0.5 * dist / this.r) +
                    (this.y < 0) * Math.PI
                this.x0 = this.x - this.r * Math.cos(a)
                this.y0 = this.y - this.r * Math.sin(a)
                this.a0 = Math.atan2(this.y - this.y0, this.x - this.x0)
                this.a1 = Math.atan2(-this.y0, -this.x0)
                if (this.a0 <= this.a1)
                    this.a0 += 2 * Math.PI
            }

            R1.beginPath()
            R1.moveTo(-50, -50)
            R1.lineTo(50, 50)
            R1.moveTo(50, -50)
            R1.lineTo(-50, 50)
            R1.strokeStyle = '#87fc70'
            R1.stroke()

            var rocket = {x: 0, y: 0}

            function mm(event) {
                var bcr = L2.getBoundingClientRect()
                rocket.x = event.clientX - 0.5 * 900 - (0|bcr.left)
                rocket.y = event.clientY - 0.5 * 600 - (0|bcr.top)

                R2.clearRect(-x0, -y0, 900, 600)

                ballistic.call(rocket)
                Rocket.prototype.render.call(rocket, 0)

                var ii = intersections(rocket.x0, rocket.y0, rocket.r)
                if (!ii) return
                R2.fillStyle = '#ff3b30'
                R2.fillRect(ii[0] - 2.5, ii[1] - 2.5, 5, 5)
                R2.fillStyle = '#007aff'
                R2.fillRect(ii[2] - 2.5, ii[3] - 2.5, 5, 5)
            }

            L2.addEventListener('mousemove', mm, false)
            L2.style.cursor = 'none'
        </script>
    </body>
</html>
